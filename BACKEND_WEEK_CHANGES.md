# Backend Changes Required for Week-Based Menu System

## Database Schema Updates

### Menu Table
Add new column `weekId` to store week identifier:
```sql
ALTER TABLE menu ADD COLUMN weekId TEXT;
CREATE INDEX idx_menu_weekId ON menu(weekId);
```

## API Endpoint Updates

### GET /menu
Add optional `weekId` query parameter to filter by week:
```typescript
app.get("/make-server-49570ec2/menu", async (c) => {
  const weekId = c.req.query("weekId");
  
  if (weekId) {
    const items = await kv.getByPrefix(`menu:${weekId}:`);
    return c.json({ success: true, data: items });
  }
  
  // Return all if no weekId specified
  const items = await kv.getByPrefix("menu:");
  return c.json({ success: true, data: items });
});
```

### POST /menu
Accept `weekId` in payload and use it in ID:
```typescript
app.post("/make-server-49570ec2/menu", async (c) => {
  const body = await c.req.json();
  const { id, weekId, day, name, ...rest } = body;
  
  // Use client-provided ID if available (already includes weekId)
  // Format: {weekId}-{day}-{dishId}-{timestamp}
  const menuItemId = id || `${weekId}-${day}-${crypto.randomUUID()}`;
  
  const menuItem = {
    id: menuItemId,
    weekId,
    day,
    name,
    ...rest,
    createdAt: new Date().toISOString(),
  };
  
  // Store with key that includes weekId
  await kv.set(`menu:${menuItemId}`, menuItem);
  return c.json({ success: true, data: menuItem });
});
```

### DELETE /menu/:id
Delete by full ID (which includes weekId):
```typescript
app.delete("/make-server-49570ec2/menu/:id", async (c) => {
  const id = c.req.param("id");
  
  // ID format: {weekId}-{day}-{dishId}-{timestamp}
  await kv.delete(`menu:${id}`);
  return c.json({ success: true });
});
```

## Week Identifier Format
- Format: `YYYY-WW` (e.g., "2025-46")
- Generated by client using `getWeekIdentifier()` function
- Consistent across timezone

## Menu Item ID Format
- Format: `{weekId}-{day}-{dishId}-{timestamp}`
- Example: `2025-46-Thứ Hai-abc123-1731686400000`
- **Each menu item is unique per week + day combination**
- Deleting a dish from Monday week 46 won't affect Monday week 47

## Migration Plan
1. Add `weekId` column to existing menu items (set to current week)
2. Update API endpoints to support filtering
3. Test with existing data
4. Deploy changes

## Benefits
- ✅ Menu items are scoped to specific weeks
- ✅ Old menu items don't show up in current week
- ✅ Orders are validated against correct week
- ✅ Easy to manage menu changes week-by-week
